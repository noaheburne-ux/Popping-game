<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MATRIX-100 | Ultimate Edition</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: #05050a;
            --surface: #0e0e1a;
            --accent: #00f2ff;
            --accent-glow: rgba(0, 242, 255, 0.3);
            --secondary: #7000ff;
            --text: #e0e6ed;
            --text-dim: #6b6b83;
            --danger: #ff0055;
            --cell-size: clamp(30px, 4.5vh, 50px);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'JetBrains Mono', 'Fira Code', monospace; }

        body {
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background-image: radial-gradient(circle at 50% 50%, #16162d 0%, #05050a 100%);
        }

        /* App Layout */
        .app-shell {
            width: 98vw;
            height: 96vh;
            display: flex;
            flex-direction: column;
            background: var(--surface);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            box-shadow: 0 0 40px rgba(0,0,0,0.8);
            position: relative;
        }

        header {
            padding: 15px 30px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo { font-size: 1.5rem; font-weight: bold; letter-spacing: 4px; color: var(--accent); }

        /* Screens */
        .screen { display: none; flex: 1; padding: 20px; animation: fadeIn 0.3s ease; }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Menu */
        .menu-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: auto; width: 80%; }
        .card {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.05);
            padding: 40px;
            text-align: center;
            border-radius: 12px;
            cursor: pointer;
            transition: 0.3s;
        }
        .card:hover { border-color: var(--accent); background: rgba(0, 242, 255, 0.05); transform: translateY(-5px); }
        .card i { font-size: 3rem; color: var(--accent); margin-bottom: 20px; }

        /* Game Screen Layout */
        .game-layout { display: grid; grid-template-columns: 320px 1fr 320px; gap: 20px; width: 100%; height: 100%; }

        /* Board */
        .board-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #000;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.05);
            padding: 10px;
        }
        .grid-10 {
            display: grid;
            grid-template-columns: repeat(10, var(--cell-size));
            grid-template-rows: repeat(10, var(--cell-size));
            gap: 6px;
        }
        .cell {
            background: #1a1a2e;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 4px;
            cursor: pointer;
            transition: 0.1s;
        }
        .cell:hover:not(.taken) { border-color: var(--accent); background: rgba(0, 242, 255, 0.1); }
        .cell.selected { background: var(--accent); box-shadow: 0 0 15px var(--accent); border: none; }
        .cell.taken { opacity: 0.05; cursor: default; }

        /* Sidebars */
        .sidebar { display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
        .panel {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 15px;
        }

        /* AI Thinking Box */
        .ai-terminal {
            flex: 1;
            font-size: 0.75rem;
            color: #00ff88;
            background: #050a05;
            padding: 10px;
            overflow-y: auto;
            border: 1px solid #004422;
            line-height: 1.4;
        }
        .ai-terminal p { margin-bottom: 5px; border-bottom: 1px solid rgba(0,255,136,0.1); }

        /* Difficulty Slider */
        .slider-container { margin: 10px 0; }
        .slider {
            width: 100%;
            accent-color: var(--accent);
            cursor: pointer;
        }

        /* Buttons */
        .btn {
            padding: 12px;
            border-radius: 6px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            transition: 0.2s;
        }
        .btn-accent { background: var(--accent); color: #000; }
        .btn-accent:disabled { opacity: 0.2; cursor: not-allowed; }
        .btn-outline { background: transparent; border: 1px solid var(--text-dim); color: var(--text); }
        .btn-outline:hover { background: rgba(255,255,255,0.05); }

        /* Lobby Info */
        .room-code {
            background: #000;
            padding: 10px;
            text-align: center;
            font-size: 1.2rem;
            color: var(--accent);
            border: 1px dashed var(--accent);
            margin: 10px 0;
        }

        /* Overlay */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .overlay.active { display: flex; }

        .player-tag {
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 4px;
            background: rgba(255,255,255,0.03);
            display: flex;
            justify-content: space-between;
        }
        .player-tag.active { border: 1px solid var(--accent); background: rgba(0,242,255,0.1); }
    </style>
</head>
<body>

    <div class="app-shell">
        <header>
            <div class="logo"><i class="fas fa-microchip"></i> MATRIX.100</div>
            <div id="status-text" style="font-size: 0.7rem; color: var(--text-dim);">SYSTEM READY</div>
        </header>

        <!-- Screen: Menu -->
        <section id="screen-menu" class="screen active">
            <div class="menu-grid">
                <div class="card" onclick="initGame('ai')">
                    <i class="fas fa-brain"></i>
                    <h3>SOLO VS AI</h3>
                    <p>Defeat the adaptive logic engine.</p>
                </div>
                <div class="card" onclick="showScreen('screen-local-setup')">
                    <i class="fas fa-users"></i>
                    <h3>LOCAL MULTI</h3>
                    <p>2-4 players on one screen.</p>
                </div>
                <div class="card" onclick="showOnlineSetup()">
                    <i class="fas fa-globe"></i>
                    <h3>ONLINE LOBBY</h3>
                    <p>Connect via secure room code.</p>
                </div>
            </div>
        </section>

        <!-- Screen: Local Setup -->
        <section id="screen-local-setup" class="screen">
            <div style="margin: auto; text-align: center;">
                <h2>SELECT PLAYER COUNT</h2>
                <div style="display: flex; gap: 20px; margin: 30px 0;">
                    <button class="btn btn-outline" onclick="initGame('local', 2)">2 PLAYERS</button>
                    <button class="btn btn-outline" onclick="initGame('local', 3)">3 PLAYERS</button>
                    <button class="btn btn-outline" onclick="initGame('local', 4)">4 PLAYERS</button>
                </div>
                <button class="btn btn-outline" onclick="showScreen('screen-menu')">BACK</button>
            </div>
        </section>

        <!-- Screen: Online Setup -->
        <section id="screen-online-setup" class="screen">
            <div style="margin: auto; width: 400px; text-align: center;">
                <h2>ONLINE LOBBY</h2>
                <div class="panel" style="margin: 20px 0;">
                    <p style="font-size: 0.7rem; color: var(--text-dim);">YOUR CODE</p>
                    <div id="my-id" class="room-code">GENERATING...</div>
                    <button class="btn btn-outline" style="font-size: 0.6rem;" onclick="copyID()">COPY</button>
                </div>
                <input type="text" id="join-id" placeholder="ENTER ROOM CODE" style="width: 100%; padding: 15px; background: #000; border: 1px solid #333; color: #fff; margin-bottom: 10px;">
                <button class="btn btn-accent" style="width: 100%;" onclick="connectOnline()">JOIN ROOM</button>
                <button class="btn btn-outline" style="width: 100%; margin-top: 10px;" onclick="location.reload()">CANCEL</button>
            </div>
        </section>

        <!-- Screen: Game -->
        <section id="screen-game" class="screen">
            <div class="game-layout">
                
                <!-- Left: AI & Difficulty -->
                <div class="sidebar">
                    <div class="panel">
                        <label style="font-size: 0.7rem; color: var(--accent);">AI COGNITION LEVEL</label>
                        <div class="slider-container">
                            <input type="range" min="1" max="20" value="10" class="slider" id="ai-difficulty">
                            <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-top: 5px;">
                                <span>LV.1</span>
                                <span id="diff-val" style="color: var(--accent);">10</span>
                                <span>LV.20</span>
                            </div>
                        </div>
                    </div>
                    <div style="flex: 1; display: flex; flex-direction: column;">
                        <label style="font-size: 0.7rem; color: #00ff88; margin-bottom: 5px;">DECISION TERMINAL</label>
                        <div id="ai-log" class="ai-terminal">
                            <p>> SYSTEM INITIALIZED...</p>
                        </div>
                    </div>
                </div>

                <!-- Center: Board -->
                <div class="board-container">
                    <div id="grid" class="grid-10"></div>
                </div>

                <!-- Right: Stats & Controls -->
                <div class="sidebar">
                    <div class="panel">
                        <label style="font-size: 0.7rem; color: var(--accent);">OPERATIVES</label>
                        <div id="player-list" style="margin-top: 10px;"></div>
                    </div>
                    
                    <div class="panel" style="margin-top: auto;">
                        <button id="end-turn-btn" class="btn btn-accent" style="width: 100%; margin-bottom: 10px;" onclick="processTurn()" disabled>END TURN</button>
                        <button class="btn btn-outline" style="width: 100%;" onclick="location.reload()">ABORT</button>
                    </div>
                </div>

            </div>
        </section>
    </div>

    <!-- Win Overlay -->
    <div id="win-overlay" class="overlay">
        <h1 style="font-size: 4rem; color: var(--danger);">DISCONNECTED</h1>
        <p id="win-message" style="margin: 20px 0 40px 0; font-size: 1.2rem;"></p>
        <button class="btn btn-accent" onclick="location.reload()">RETURN TO MENU</button>
    </div>

    <script>
        const GAME = {
            board: [],
            players: [],
            turn: 0,
            activeRow: -1,
            selected: [],
            mode: 'ai', // ai, local, online
            difficulty: 10,
            peer: null,
            conn: null,
            isHost: false
        };

        // --- INIT ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function initGame(mode, pCount = 2) {
            GAME.mode = mode;
            GAME.board = Array(10).fill().map(() => Array(10).fill(true));
            GAME.turn = 0;
            GAME.activeRow = -1;
            GAME.selected = [];

            if(mode === 'ai') {
                GAME.players = [{name: 'USER', type: 'h'}, {name: 'CPU', type: 'ai'}];
            } else if (mode === 'local') {
                GAME.players = [];
                for(let i=1; i<=pCount; i++) GAME.players.push({name: `P.0${i}`, type: 'h'});
            }

            showScreen('screen-game');
            buildBoard();
            updateUI();
        }

        function buildBoard() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            for(let r=0; r<10; r++) {
                for(let c=0; c<10; c++) {
                    const div = document.createElement('div');
                    div.className = 'cell';
                    if(!GAME.board[r][c]) div.classList.add('taken');
                    div.onclick = () => handleCellClick(r, c);
                    grid.appendChild(div);
                }
            }
        }

        // --- CORE LOGIC ---
        function handleCellClick(r, c) {
            // Turn validation
            if(GAME.mode === 'online') {
                if(GAME.isHost && GAME.turn !== 0) return;
                if(!GAME.isHost && GAME.turn !== 1) return;
            }
            if(GAME.players[GAME.turn].type === 'ai') return;

            if(!GAME.board[r][c]) return;
            if(GAME.activeRow !== -1 && GAME.activeRow !== r) return;

            const idx = GAME.selected.findIndex(s => s.r === r && s.c === c);
            if(idx > -1) {
                GAME.selected.splice(idx, 1);
                if(GAME.selected.length === 0) GAME.activeRow = -1;
            } else {
                GAME.activeRow = r;
                GAME.selected.push({r, c});
            }

            document.getElementById('end-turn-btn').disabled = GAME.selected.length === 0;
            refreshCells();
        }

        function refreshCells() {
            const cells = document.querySelectorAll('.cell');
            cells.forEach((cell, i) => {
                const r = Math.floor(i / 10);
                const c = i % 10;
                cell.classList.remove('selected');
                if(GAME.selected.some(s => s.r === r && s.c === c)) cell.classList.add('selected');
            });
        }

        function processTurn() {
            GAME.selected.forEach(s => GAME.board[s.r][s.c] = false);
            GAME.selected = [];
            GAME.activeRow = -1;
            document.getElementById('end-turn-btn').disabled = true;

            buildBoard();
            if(checkWin()) return;

            GAME.turn = (GAME.turn + 1) % GAME.players.length;
            updateUI();

            if(GAME.mode === 'online') sync();
            if(GAME.players[GAME.turn].type === 'ai') setTimeout(runAI, 1000);
        }

        function checkWin() {
            const remaining = GAME.board.flat().filter(x => x === true).length;
            if(remaining === 0) {
                const loser = GAME.players[GAME.turn].name;
                document.getElementById('win-message').innerText = `${loser} HAS BEEN ELIMINATED BY THE LAST CELL.`;
                document.getElementById('win-overlay').classList.add('active');
                return true;
            }
            return false;
        }

        function updateUI() {
            const list = document.getElementById('player-list');
            list.innerHTML = '';
            GAME.players.forEach((p, i) => {
                const div = document.createElement('div');
                div.className = `player-tag ${GAME.turn === i ? 'active' : ''}`;
                div.innerHTML = `<span>${p.name}</span><span>${GAME.turn === i ? 'ACTIVE' : '--'}</span>`;
                list.appendChild(div);
            });
        }

        // --- AI LOGIC (NIM SUM) ---
        function runAI() {
            const log = (msg) => {
                const term = document.getElementById('ai-log');
                const p = document.createElement('p');
                p.innerText = `> ${msg}`;
                term.prepend(p);
            };

            log("ANALYZING MATRIX...");
            const counts = GAME.board.map(row => row.filter(c => c).length);
            
            // Nim Sum Strategy
            let nimSum = counts.reduce((a, b) => a ^ b, 0);
            log(`NIM_SUM DETECTED: ${nimSum.toString(2).padStart(4, '0')}`);

            let targetRow = -1;
            let takeCount = 0;

            // Difficulty check: Probability of making the perfect move
            const perfectMove = Math.random() * 20 < GAME.difficulty;

            if(!perfectMove) {
                log("COGNITION ERROR: MAKING SUB-OPTIMAL MOVE");
                targetRow = counts.findIndex(c => c > 0);
                takeCount = 1;
            } else {
                // Misere Play Strategy (Last one loses)
                const pilesAboveOne = counts.filter(c => c > 1).length;
                if(pilesAboveOne <= 1) {
                    log("END-GAME PROTOCOL ENGAGED");
                    const bigIdx = counts.findIndex(c => c > 1);
                    const ones = counts.filter(c => c === 1).length;
                    if(bigIdx === -1) {
                        targetRow = counts.findIndex(c => c === 1);
                        takeCount = 1;
                    } else {
                        takeCount = (ones % 2 === 0) ? counts[bigIdx] - 1 : counts[bigIdx];
                        if(takeCount === 0) takeCount = 1;
                        targetRow = bigIdx;
                    }
                } else {
                    if(nimSum === 0) {
                        log("STATE IS BALANCED. STALLING...");
                        targetRow = counts.findIndex(c => c > 0);
                        takeCount = 1;
                    } else {
                        for(let i=0; i<10; i++) {
                            let target = counts[i] ^ nimSum;
                            if(target < counts[i]) {
                                targetRow = i;
                                takeCount = counts[i] - target;
                                break;
                            }
                        }
                    }
                }
            }

            log(`EXECUTING: ROW ${targetRow+1} | TAKE ${takeCount}`);
            
            // Execute AI move
            let processed = 0;
            for(let c=0; c<10; c++) {
                if(GAME.board[targetRow][c] && processed < takeCount) {
                    GAME.board[targetRow][c] = false;
                    processed++;
                }
            }

            setTimeout(processTurn, 500);
        }

        // --- ONLINE LOGIC ---
        function showOnlineSetup() {
            showScreen('screen-online-setup');
            GAME.peer = new Peer();
            GAME.peer.on('open', id => document.getElementById('my-id').innerText = id);
            GAME.peer.on('connection', conn => {
                GAME.conn = conn;
                GAME.isHost = true;
                handleConnection();
            });
        }

        function connectOnline() {
            const id = document.getElementById('join-id').value;
            GAME.conn = GAME.peer.connect(id);
            GAME.isHost = false;
            handleConnection();
        }

        function handleConnection() {
            GAME.mode = 'online';
            GAME.players = [{name: 'HOST', type: 'h'}, {name: 'GUEST', type: 'h'}];
            GAME.conn.on('data', data => {
                if(data.type === 'SYNC') {
                    GAME.board = data.board;
                    GAME.turn = data.turn;
                    buildBoard();
                    updateUI();
                    checkWin();
                }
            });
            initGame('online');
        }

        function sync() {
            if(GAME.conn) GAME.conn.send({ type: 'SYNC', board: GAME.board, turn: GAME.turn });
        }

        function copyID() {
            navigator.clipboard.writeText(document.getElementById('my-id').innerText);
            alert("CODE COPIED");
        }

        // --- UI EVENTS ---
        document.getElementById('ai-difficulty').oninput = function() {
            GAME.difficulty = this.value;
            document.getElementById('diff-val').innerText = this.value;
        };

    </script>
</body>
</html>
